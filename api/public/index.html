<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .container { margin-top: 50px; }
    .form-group { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>User Management</h1>
    
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">Add/Edit User</div>
          <div class="card-body">
            <form id="userForm">
              <input type="hidden" id="userId">
              <div class="form-group">
                <label for="username">Username</label>
                <input type="text" class="form-control" id="username" required>
              </div>
              <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" required>
              </div>
              <div class="form-group">
                <label for="displayName">Display Name</label>
                <input type="text" class="form-control" id="displayName">
              </div>
              <div class="form-group">
                <label for="role">Role</label>
                <select class="form-control" id="role">
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Save User</button>
              <button type="button" id="cancelEdit" class="btn btn-secondary" style="display: none;">Cancel</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">User List</div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Display Name</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- User data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // API URL - use /auth-api when accessed via proxy, /api when direct
      const API_URL = window.location.pathname.includes('/usermanagement') ? "/auth-api" : "/api";
      
      // DOM Elements
      const userForm = document.getElementById("userForm");
      const userIdField = document.getElementById("userId");
      const usernameField = document.getElementById("username");
      const passwordField = document.getElementById("password");
      const displayNameField = document.getElementById("displayName");
      const roleField = document.getElementById("role");
      const cancelEditButton = document.getElementById("cancelEdit");
      const userTableBody = document.getElementById("userTableBody");
      
      // Load users on page load
      loadUsers();
      
      // Form submission
      userForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const userData = {
          username: usernameField.value,
          password: passwordField.value,
          displayName: displayNameField.value,
          role: roleField.value
        };
        
        const userId = userIdField.value;
        
        if (userId) {
          // Update existing user
          updateUser(userId, userData);
        } else {
          // Create new user
          createUser(userData);
        }
      });
      
      // Cancel edit button
      cancelEditButton.addEventListener("click", resetForm);
      
      // Load all users
      function loadUsers() {
        fetch(`${API_URL}/users`)
          .then(response => response.json())
          .then(users => {
            userTableBody.innerHTML = "";
            
            users.forEach(user => {
              const row = document.createElement("tr");
              
              row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.displayName || user.username}</td>
                <td>${user.role}</td>
                <td>
                  <button class="btn btn-sm btn-info edit-btn" data-id="${user._id}">Edit</button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${user._id}">Delete</button>
                </td>
              `;
              
              userTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll(".edit-btn").forEach(btn => {
              btn.addEventListener("click", function() {
                const userId = this.getAttribute("data-id");
                editUser(userId);
              });
            });
            
            document.querySelectorAll(".delete-btn").forEach(btn => {
              btn.addEventListener("click", function() {
                const userId = this.getAttribute("data-id");
                deleteUser(userId);
              });
            });
          })
          .catch(error => {
            console.error("Error loading users:", error);
            alert("Failed to load users");
          });
      }
      
      // Create a new user
      function createUser(userData) {
        fetch(`${API_URL}/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                throw new Error(data.message || "Failed to create user");
              });
            }
            return response.json();
          })
          .then(() => {
            resetForm();
            loadUsers();
            alert("User created successfully");
          })
          .catch(error => {
            alert(`Error: ${error.message}`);
          });
      }
      
      // Update an existing user
      function updateUser(userId, userData) {
        fetch(`${API_URL}/users/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                throw new Error(data.message || "Failed to update user");
              });
            }
            return response.json();
          })
          .then(() => {
            resetForm();
            loadUsers();
            alert("User updated successfully");
          })
          .catch(error => {
            alert(`Error: ${error.message}`);
          });
      }
      
      // Edit a user (load data into form)
      function editUser(userId) {
        fetch(`${API_URL}/users/${userId}`)
          .then(response => response.json())
          .then(user => {
            userIdField.value = user._id;
            usernameField.value = user.username;
            displayNameField.value = user.displayName || "";
            roleField.value = user.role;
            
            // Clear password field for security
            passwordField.value = "";
            
            // Show cancel button
            cancelEditButton.style.display = "inline-block";
          })
          .catch(error => {
            console.error("Error:", error);
            alert("Failed to load user details");
          });
      }
      
      // Delete a user
      function deleteUser(userId) {
        if (confirm("Are you sure you want to delete this user?")) {
          fetch(`${API_URL}/users/${userId}`, {
            method: "DELETE"
          })
            .then(response => {
              if (!response.ok) {
                return response.json().then(data => {
                  throw new Error(data.message || "Failed to delete user");
                });
              }
              return response.json();
            })
            .then(() => {
              loadUsers();
              alert("User deleted successfully");
            })
            .catch(error => {
              alert(`Error: ${error.message}`);
            });
        }
      }
      
      // Reset form to add new user state
      function resetForm() {
        userForm.reset();
        userIdField.value = "";
        cancelEditButton.style.display = "none";
      }
    });
  </script>
</body>
</html>
